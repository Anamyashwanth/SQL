# üìò MERGE Command ‚Äì SQL Server (SSMS)

---

## 1Ô∏è‚É£ What is MERGE Command?

The **`MERGE` command** is a **DML (Data Manipulation Language)** statement used to **synchronize data between two tables** by performing **INSERT, UPDATE, and DELETE in a single statement**.

<br>> ‚úî MERGE compares two tables
<br>> ‚úî MERGE decides **what to insert, update, or delete**
<br>> ‚úî MERGE is commonly used in **ETL and data sync jobs**

---

## 2Ô∏è‚É£ Why MERGE Command is Used?

MERGE is used when:

* Data must be synchronized between source and target tables
* New records must be inserted
* Existing records must be updated
* Old records must be deleted
* All operations should be **atomic**

üëâ Instead of writing **multiple INSERT / UPDATE / DELETE statements**, MERGE does it **in one step**.

---

## 3Ô∏è‚É£ Position of MERGE in DML Flow

> **INSERT + UPDATE + DELETE ‚Üí MERGE**

MERGE combines all three DML operations.

---

## 4Ô∏è‚É£ Tables Used in MERGE

| Table           | Role                     |
| --------------- | ------------------------ |
| Target table    | Table to be updated      |
| Source table    | Table providing new data |
| Match condition | Decides how rows relate  |

---

## 5Ô∏è‚É£ Basic MERGE Syntax

```sql
MERGE target_table AS T
USING source_table AS S
ON match_condition
WHEN MATCHED THEN
    UPDATE SET column = value
WHEN NOT MATCHED THEN
    INSERT (columns) VALUES (values);
GO
```

---

## 6Ô∏è‚É£ Example Tables (Assume Existing)

### Students (Target Table)

| StudentID | StudentName | Marks |
| --------- | ----------- | ----- |
| 1         | Rahul       | 60    |
| 2         | Anil        | 70    |

---

### NewStudents (Source Table)

| StudentID | StudentName | Marks |
| --------- | ----------- | ----- |
| 1         | Rahul       | 80    |
| 3         | Kiran       | 75    |

---

## 7Ô∏è‚É£ MERGE Example (INSERT + UPDATE)

```sql
MERGE Students AS T
USING NewStudents AS S
ON T.StudentID = S.StudentID

WHEN MATCHED THEN
    UPDATE SET
        T.StudentName = S.StudentName,
        T.Marks = S.Marks

WHEN NOT MATCHED THEN
    INSERT (StudentID, StudentName, Marks)
    VALUES (S.StudentID, S.StudentName, S.Marks);
GO
```

---

## 8Ô∏è‚É£ Step-by-Step: What Happens?

1Ô∏è‚É£ SQL Server compares both tables using `StudentID`
2Ô∏è‚É£ If match found ‚Üí UPDATE runs
3Ô∏è‚É£ If no match found ‚Üí INSERT runs
4Ô∏è‚É£ Both operations happen **in one execution**

---

## 9Ô∏è‚É£ Result After MERGE

### Students table after MERGE

| StudentID | StudentName | Marks |
| --------- | ----------- | ----- |
| 1         | Rahul       | 80    |
| 2         | Anil        | 70    |
| 3         | Kiran       | 75    |

---

## üîü MERGE with DELETE (Advanced)

### Scenario

Delete rows from target table if they don‚Äôt exist in source table.

```sql
MERGE Students AS T
USING NewStudents AS S
ON T.StudentID = S.StudentID

WHEN MATCHED THEN
    UPDATE SET T.Marks = S.Marks

WHEN NOT MATCHED BY SOURCE THEN
    DELETE;
GO
```

---

## 1Ô∏è‚É£1Ô∏è‚É£ MERGE with WHERE Condition

### Scenario

Update only if new marks are greater than old marks.

```sql
MERGE Students AS T
USING NewStudents AS S
ON T.StudentID = S.StudentID

WHEN MATCHED AND S.Marks > T.Marks THEN
    UPDATE SET T.Marks = S.Marks

WHEN NOT MATCHED THEN
    INSERT (StudentID, StudentName, Marks)
    VALUES (S.StudentID, S.StudentName, S.Marks);
GO
```

---

## 1Ô∏è‚É£2Ô∏è‚É£ MERGE and TRANSACTIONS (SSMS)

```sql
BEGIN TRAN;

MERGE Students AS T
USING NewStudents AS S
ON T.StudentID = S.StudentID
WHEN MATCHED THEN
    UPDATE SET T.Marks = S.Marks
WHEN NOT MATCHED THEN
    INSERT (StudentID, StudentName, Marks)
    VALUES (S.StudentID, S.StudentName, S.Marks);

ROLLBACK;
GO
```

<br>‚úî Safe testing
<br>‚úî COMMIT to save changes

---

## 1Ô∏è‚É£3Ô∏è‚É£ MERGE vs JOIN UPDATE (Interview)

| MERGE                    | JOIN UPDATE  |
| ------------------------ | ------------ |
| Multiple operations      | Update only  |
| Insert + Update + Delete | Update       |
| Complex                  | Simple       |
| Used in ETL              | Used in sync |

---

## 1Ô∏è‚É£4Ô∏è‚É£ MERGE Limitations & Warnings

‚ö†Ô∏è MERGE can cause:

* Performance issues on large tables
* Unexpected results if source has duplicates
* Deadlocks in high concurrency

<br>‚úî Use carefully in production
<br>‚úî Always test first

---

## 1Ô∏è‚É£5Ô∏è‚É£ Best Practices for MERGE

<br>‚úî Ensure source data has no duplicates
<br>‚úî Always test using SELECT first
<br>‚úî Use transactions
<br>‚úî Add appropriate indexes
<br>‚úî Avoid MERGE for simple updates

---

## üß† One-Line Memory

> **MERGE synchronizes two tables using INSERT, UPDATE, and DELETE in one statement**
